<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <body>
    <div id="main" th:fragment="content">
      <header class="mb-3">
        <a href="#" class="burger-btn d-block d-xl-none">
          <i class="bi bi-justify fs-3"></i>
        </a>
      </header>

      <div class="page-heading">
        <div class="page-title">
          <div class="row">
            <div class="col-12 col-md-6 order-md-1 order-last">
              <h3 th:text="${course.title + ' - Danh sách học viên'}"></h3>
            </div>
            <div class="col-12 col-md-6 order-md-2 order-first">
              <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Tổng quan</a></li>
                  <li class="breadcrumb-item"><a th:href="@{/admin/course-enroll}">Thêm vào khóa học</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Danh sách học viên</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
        <section class="section">
          <div class="card">
            <div class="card-header">
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#studentsModel">
                Thêm học viên
              </button>
              <form
                id="excel-form"
                th:action="@{/admin/import-excel-users-to-course}"
                method="post"
                enctype="multipart/form-data"
                style="display: inline-block"
              >
                <!-- Nút "Nhập Excel" -->
                <button type="button" class="btn btn-primary" onclick="triggerFileInput()">Nhập Excel</button>

                <input type="hidden" name="courseId" th:value="${course.courseId}" />

                <!-- Input file ẩn đi -->
                <input
                  type="file"
                  name="file"
                  accept=".xlsx, .xls"
                  class="form-control"
                  id="file-upload"
                  style="display: none"
                  onchange="submitForm()"
                />
              </form>
              <a class="btn btn-primary" th:href="@{/admin/download-excel-enrolled-users/{id}(id=${course.courseId})}"
                >Tải danh sách
              </a>
            </div>
            <div class="card-body">
              <table class="table table-striped" id="table1">
                <thead>
                  <tr>
                    <th>STT</th>
                    <th>Mã sinh viên</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>SĐT</th>
                    <th>Ngày thêm</th>
                    <th>Người thêm</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="enrollment, stat : ${course.enrollments}">
                    <td th:text="${stat.index + 1}"></td>
                    <td th:text="${enrollment.user.id}"></td>
                    <td th:text="${enrollment.user.fullname}"></td>
                    <td th:text="${enrollment.user.email}"></td>
                    <td th:text="${enrollment.user.phoneNumber}"></td>
                    <td th:text="${#dates.format(enrollment.enrolledAt, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${enrollment.enrolledBy != null ? enrollment.enrolledBy.fullname : 'N/A'}"></td>

                    <td>
                      <form
                        th:action="@{/admin/course-enroll/delete}"
                        onsubmit="return confirm('Bạn có chắc chắn muốn xóa học viên này?')"
                        method="post"
                        style="display: inline"
                      >
                        <input type="hidden" name="_method" value="delete" />
                        <input type="hidden" name="enrollmentId" th:value="${enrollment.enrollmentId}" />
                        <input type="hidden" name="courseId" th:value="${enrollment.course.courseId}" />
                        <button type="submit" class="btn btn-danger btn-sm">Xóa</button>
                      </form>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- danh sách học viên -->
      <div
        class="modal fade"
        id="studentsModel"
        tabindex="-1"
        aria-labelledby="studentsModelTitle"
        style="display: none"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
          <!-- modal-lg để mở rộng chiều rộng -->
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="studentsModelTitle">Danh sách học viên</h5>
              <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <i data-feather="x"></i>
              </button>
            </div>
            <div class="modal-body">
              <!-- Bảng danh sách học viên với checkbox -->
              <form th:action="@{/admin/add-users-to-course}" method="post" onsubmit="return checkUserSelection()">
                <input type="hidden" name="courseId" th:value="${course.courseId}" />
                <table class="table">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="select-all" /></th>
                      <th>STT</th>
                      <th>Họ tên</th>
                      <th>Email</th>
                      <th>SĐT</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="user, stat : ${users}">
                      <td><input type="checkbox" name="userIds" th:value="${user.id}" /></td>
                      <td th:text="${stat.index + 1}"></td>
                      <td th:text="${user.fullname}"></td>
                      <td th:text="${user.email}"></td>
                      <td th:text="${user.phoneNumber}"></td>
                    </tr>
                  </tbody>
                </table>
                <div class="modal-footer">
                  <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
                    <span class="d-none d-sm-block">Hủy</span>
                  </button>
                  <button type="submit" class="btn btn-primary ml-1">
                    <span class="d-none d-sm-block">Thêm học viên</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Preview Excel -->
      <div
        class="modal fade"
        id="excelPreviewModal"
        tabindex="-1"
        aria-labelledby="excelPreviewModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="excelPreviewModalLabel">Xem trước dữ liệu Excel</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
              <table class="table table-bordered" id="preview-table">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button class="btn btn-success" onclick="confirmAndSubmit()">Xác nhận và nhập vào khóa học</button>
              <button class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelUpload()">Hủy</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <th:block th:fragment="scripts">
      <script>
        // Simple Datatable
        let table1 = document.querySelector("#table1");
        let dataTable = new simpleDatatables.DataTable(table1);

        document.getElementById("select-all").addEventListener("change", function () {
          var isChecked = this.checked;
          var checkboxes = document.querySelectorAll('input[name="userIds"]');
          checkboxes.forEach(function (checkbox) {
            checkbox.checked = isChecked;
          });
        });

        function triggerFileInput() {
          document.getElementById("file-upload").click(); // Kích hoạt sự kiện click cho input file ẩn
        }

        function submitForm() {
          const fileInput = document.getElementById("file-upload");
          const file = fileInput.files[0];

          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            showPreview(json);
          };
          reader.readAsArrayBuffer(file);
        }

        function showPreview(data) {
          if (data.length === 0) return;

          const table = document.getElementById("preview-table");
          const thead = table.querySelector("thead");
          const tbody = table.querySelector("tbody");

          thead.innerHTML = "";
          tbody.innerHTML = "";

          // Render header
          const headerRow = document.createElement("tr");
          data[0].forEach((cell) => {
            const th = document.createElement("th");
            th.textContent = cell;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          // Render data rows
          for (let i = 1; i < data.length; i++) {
            const row = document.createElement("tr");
            data[i].forEach((cell) => {
              const td = document.createElement("td");
              td.textContent = cell;
              row.appendChild(td);
            });
            tbody.appendChild(row);
          }

          // Mở modal bằng Bootstrap
          const modal = new bootstrap.Modal(document.getElementById("excelPreviewModal"));
          modal.show();
        }

        function confirmAndSubmit() {
          document.getElementById("excel-form").submit();
        }

        function cancelUpload() {
          document.getElementById("file-upload").value = "";
          document.getElementById("excel-preview").style.display = "none";
        }

        function checkUserSelection() {
          var checkboxes = document.querySelectorAll('input[name="userIds"]');
          var anyChecked = Array.from(checkboxes).some((cb) => cb.checked);

          if (!anyChecked) {
            alert("Vui lòng chọn ít nhất một học viên để thêm vào khóa học.");
            return false;
          }
          return true;
        }
      </script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    </th:block>
  </body>
</html>
