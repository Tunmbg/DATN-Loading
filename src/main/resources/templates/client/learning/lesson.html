<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <body class="rbt-header-sticky">
    <div th:fragment="content">
      <div class="rbt-lesson-area bg-color-white">
        <div class="rbt-lesson-content-wrapper">
          <div
            th:replace="~{client/learning/learning-sidebar :: learning-sidebar}"
          ></div>

          <div class="rbt-lesson-rightsidebar overflow-hidden lesson-video">
            <div class="lesson-top-bar">
              <div class="lesson-top-left">
                <div class="rbt-lesson-toggle">
                  <button
                    class="lesson-toggle-active btn-round-white-opacity"
                    title="Toggle Sidebar"
                  >
                    <i class="feather-arrow-left"></i>
                  </button>
                </div>
                <h5>
                  Trọn bộ Vietstudy 2025: Hành trình từ con số 0 đến chuyên gia!
                </h5>
              </div>
              <div class="lesson-top-right">
                <div class="rbt-btn-close">
                  <a
                    th:href="@{/course-details/{id}(id=${course.courseId})}"
                    title="Go Back to Course"
                    class="rbt-round-btn"
                    ><i class="feather-x"></i
                  ></a>
                </div>
              </div>
            </div>

            <div class="inner">
              <div class="plyr__video-embed rbtplayer">
                <iframe
                  id="lecturePlayer"
                  width="100%"
                  height="500"
                  src=""
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen
                ></iframe>
              </div>
              <div class="content">
                <div class="section-title">
                  <h4>Về bài học</h4>
                  <p>
                    Hãy cùng nhau phân tích những bản hit vĩ đại nhất trong quá
                    khứ và tìm hiểu điều gì khiến chúng trở nên đặc biệt đến
                    vậy.
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-color-extra2 ptb--15 overflow-hidden">
              <div class="rbt-button-group">
                <a
                  class="rbt-btn icon-hover icon-hover-left btn-md bg-primary-opacity"
                  href="#"
                >
                  <span class="btn-icon"
                    ><i class="feather-arrow-left"></i
                  ></span>
                  <span class="btn-text">Previous</span>
                </a>

                <a class="rbt-btn icon-hover btn-md" href="#">
                  <span class="btn-text">Next</span>
                  <span class="btn-icon"
                    ><i class="feather-arrow-right"></i
                  ></span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="rbt-progress-parent">
        <svg
          class="rbt-back-circle svg-inner"
          width="100%"
          height="100%"
          viewBox="-1 -1 102 102"
        >
          <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
        </svg>
      </div>
    </div>
    <div th:fragment="scripts">
      <style>
        .hidden {
          display: none;
        }
        .chatbot-popup {
          position: fixed;
          bottom: 20px;
          right: 25px;
          width: 350px;
          background: #fff;
          border: 1px solid #ccc;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          z-index: 1000;
        }
        .chatbot-header {
          padding: 10px;
          background: #007bff;
          color: #fff;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-radius: 8px 8px 0 0;
        }
        .chatbot-body {
          padding: 10px;
          max-height: 300px;
          overflow-y: auto;
        }
        .chatbot-input {
          display: flex;
          padding: 10px;
          border-top: 1px solid #ccc;
        }
        .chatbot-input input {
          flex: 1;
          padding: 5px;
          border: 1px solid #ccc;
          border-radius: 4px;
        }
        .chatbot-input button {
          margin-left: 5px;
          padding: 5px 10px;
          background: #007bff;
          color: #fff;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }
        .chatbot-message {
          margin-bottom: 10px;
          padding: 8px;
          border-radius: 4px;
        }
        .chatbot-message.user {
          background: #007bff;
          color: #fff;
          align-self: flex-end;
        }
        .chatbot-message.bot {
          background: #f1f1f1;
          color: #333;
          align-self: flex-start;
        }
      </style>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const links = document.querySelectorAll("[data-video-url]");
          const player = document.getElementById("lecturePlayer");

          function toEmbedUrl(url) {
            if (!url) return "";

            // Trường hợp: https://www.youtube.com/watch?v=abc123
            if (url.includes("watch?v=")) {
              const videoId = url.split("watch?v=")[1].split("&")[0];
              return "https://www.youtube.com/embed/" + videoId;
            }

            // Trường hợp: https://youtu.be/abc123
            if (url.includes("youtu.be/")) {
              const videoId = url.split("youtu.be/")[1].split("?")[0];
              return "https://www.youtube.com/embed/" + videoId;
            }

            // Nếu đã là dạng embed rồi hoặc link khác -> giữ nguyên
            return url;
          }

          if (!player) {
            console.error("Không tìm thấy iframe #lecturePlayer");
            return;
          }

          links.forEach(function (link) {
            link.addEventListener("click", function (event) {
              event.preventDefault();
              let videoUrl = link.getAttribute("data-video-url");
              let embedUrl = toEmbedUrl(videoUrl);

              console.log("Đã click vào bài giảng:", embedUrl);
              player.setAttribute("src", embedUrl);
            });
          });
        });
      </script>
      <div id="chatbot" class="chatbot-popup hidden">
        <div class="chatbot-header">
          <h4>Trợ lý học tập</h4>
          <button id="chatbotClose" class="close-btn">&times;</button>
        </div>
        <div class="chatbot-body">
          <div id="chatbotMessages" class="chatbot-messages"></div>
          <div class="chatbot-input">
            <input
              id="chatbotInput"
              type="text"
              placeholder="Nhập câu hỏi của bạn..."
            />
            <button id="chatbotSend" class="send-btn">Gửi</button>
          </div>
        </div>
      </div>
      <script src="/js/chatbot.js"></script>
    </div>
  </body>
</html>
